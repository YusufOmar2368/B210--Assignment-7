#!/usr/bin/env python3
"""
Compute percent of players by position for a given year and write to CSV.

Usage:
    python3 /Users/yomar/Downloads/position_percent_by_year.py 1987
    or from Python:
    from position_percent_by_year import percent_by_position
    percent_by_position(1987)
"""
import csv
import os
import sys
from typing import Optional

DEFAULT_CSV = "/Users/yomar/Downloads/combine.csv"


def _to_int_year(s: Optional[str]) -> Optional[int]:
    if s is None:
        return None
    s = str(s).strip()
    if s == "":
        return None
    try:
        return int(float(s))
    except Exception:
        digits = "".join(ch for ch in s if ch.isdigit())
        return int(digits) if digits else None


def percent_by_position(year: int,
                        csv_path: str = DEFAULT_CSV,
                        out_path: Optional[str] = None) -> str:
    """
    Calculate percent of players per position for the specified year and
    write results to a CSV file. Returns the path to the output file.

    Output CSV columns: position,count,percent (percent with two decimals)
    """
    if not os.path.isfile(csv_path):
        raise FileNotFoundError(csv_path)

    if out_path is None:
        out_path = f"/Users/yomar/Downloads/position_percent_{year}.csv"

    counts = {}
    total = 0
    with open(csv_path, newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        if not reader.fieldnames:
            raise ValueError("CSV has no header")
        # find likely year and position columns
        year_col = next((h for h in reader.fieldnames if "year" in h.lower()), None)
        pos_col = next((h for h in reader.fieldnames if "position" in h.lower()), None)
        if year_col is None:
            raise ValueError("No year column found in CSV header")
        if pos_col is None:
            # fallback: try common alternatives
            for h in reader.fieldnames:
                if any(k in h.lower() for k in ("pos", "position", "combineposition")):
                    pos_col = h
                    break
        if pos_col is None:
            raise ValueError("No position column found in CSV header")

        for row in reader:
            y = _to_int_year(row.get(year_col))
            if y != year:
                continue
            pos = (row.get(pos_col) or "").strip() or "UNKNOWN"
            counts[pos] = counts.get(pos, 0) + 1
            total += 1

    if total == 0:
        # create an empty CSV with header and return path
        with open(out_path, "w", newline="", encoding="utf-8") as outf:
            writer = csv.writer(outf)
            writer.writerow(["position", "count", "percent"])
        return out_path

    # prepare rows sorted by descending percent
    rows = []
    for pos, cnt in sorted(counts.items(), key=lambda kv: kv[1], reverse=True):
        pct = (cnt / total) * 100.0
        rows.append((pos, cnt, f"{pct:.2f}"))

    # write output file
    with open(out_path, "w", newline="", encoding="utf-8") as outf:
        writer = csv.writer(outf)
        writer.writerow(["position", "count", "percent"])
        for pos, cnt, pct in rows:
            writer.writerow([pos, cnt, pct])

    return out_path


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 position_percent_by_year.py <year> [input_csv] [output_csv]")
        sys.exit(1)
    try:
        yr = int(sys.argv[1])
    except Exception:
        print("Year must be an integer")
        sys.exit(1)
    csv_in = sys.argv[2] if len(sys.argv) > 2 else DEFAULT_CSV
    csv_out = sys.argv[3] if len(sys.argv) > 3 else None
    out = percent_by_position(yr, csv_in, csv_out)
    print(f"Wrote position percentages to {out}")